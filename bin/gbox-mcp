#!/usr/bin/env bash

# gbox-mcp - Handles MCP configuration operations
# Usage: gbox-mcp <command> [arguments]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common"

# Command specific help content
CMD_NAME="gbox mcp"
CMD_SHORT_DESC="Manage MCP configuration operations"
CMD_USAGE="gbox mcp <command>"

CMD_COMMANDS=$(cat <<'EOF'
    export          Export MCP configuration for Claude Desktop
EOF
)

CMD_EXAMPLES=$(cat <<'EOF'
    gbox mcp export         # Export MCP configuration for Claude Desktop
EOF
)

# Help message wrapper
help() {
    show_help "${1:-all}" "$CMD_NAME" "$CMD_SHORT_DESC" "$CMD_USAGE" "$CMD_COMMANDS" "$CMD_EXAMPLES"
}

# Export command
export_config() {
    if [[ "$1" == "--help" ]]; then
        show_help "$2" "gbox mcp export" "Export MCP configuration for Claude Desktop" \
            "gbox mcp export [--merge] [--dry-run]" \
            "    --merge          Merge configuration into Claude Desktop config file" \
            "    --dry-run        Preview merge result without applying changes" \
            "    gbox mcp export         # Export MCP configuration for Claude Desktop" \
            "    gbox mcp export --merge # Export and merge into Claude Desktop config" \
            "    gbox mcp export --merge --dry-run # Preview merge result"
        return
    fi

    # Get the absolute path to the mcp-server dist directory
    local mcp_server_dir="$SCRIPT_DIR/../packages/mcp-server"
    local server_script="$mcp_server_dir/dist/index.js"
    local claude_config="$HOME/Library/Application Support/Claude/claude_desktop_config.json"
    local dry_run=false
    local do_merge=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                dry_run=true
                shift
                ;;
            --merge)
                do_merge=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Check if the server script exists
    if [[ ! -f "$server_script" ]]; then
        echo "Error: Server script not found at $server_script"
        echo "Please build the MCP server first by running:"
        echo "  cd $mcp_server_dir && pnpm build"
        exit 1
    fi

    # Generate the configuration based on DEBUG mode
    local config
    if [[ "$DEBUG" == "true" ]]; then
        config=$(cat <<EOF
{
  "mcpServers": {
    "gbox": {
      "command": "bash",
      "args": [
        "-c",
        "cd $(realpath "$mcp_server_dir") && pnpm --silent dev"
      ]
    }
  }
}
EOF
)
    else
        config=$(cat <<EOF
{
  "mcpServers": {
    "gbox": {
      "command": "node",
      "args": [
        "$(realpath "$server_script")"
      ]
    }
  }
}
EOF
)
    fi

    # Check if Claude config exists
    if [[ -f "$claude_config" ]]; then
        if [[ "$do_merge" == "true" ]]; then
            # Merge the configuration
            local temp_config=$(mktemp)
            echo "$config" > "$temp_config"
            
            if [[ "$dry_run" == "true" ]]; then
                echo "Preview of merged configuration:"
                echo "----------------------------------------"
                jq -s '.[0] * .[1]' "$claude_config" "$temp_config"
            else
                jq -s '.[0] * .[1]' "$claude_config" "$temp_config" > "${claude_config}.new"
                mv "${claude_config}.new" "$claude_config"
                echo "Configuration merged into $claude_config"
            fi
        else
            echo "$config"
            echo
            echo "To merge this configuration into Claude Desktop config, run:"
            echo "  gbox mcp export --merge"
        fi
    else
        echo "$config"
    fi
}

# Main command handler
case "$1" in
    export)
        shift
        export_config "$@"
        ;;
    --help|help)
        help "${2:-all}"
        exit 0
        ;;
    *)
        help
        [[ "$1" != "" ]] && exit 1
        exit 0
        ;;
esac
